{% extends "otree/Page.html" %}
{% block content %}

<h3>ë‹¹ì‹ ì€ ì´ì•¼ê¸°ì˜ ì£¼ì¸ê³µì´ ë˜ì–´ AIì—ê²Œ ë‹¹ì‹ ì˜ ê°ì •ì„ ì´ì•¼ê¸° í•´ ë³´ì„¸ìš” (ì´ {{ C.MAX_TURNS }}íšŒ)</h3>

<div id="chatbox" style="border:1px solid #ccc;height:300px;overflow:auto;padding:10px;background-color: #f9f9f9;"></div>

<br>

<input id="user_input" type="text" style="width:80%" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
<button id="sendBtn" type="button" class="btn btn-primary">ë³´ë‚´ê¸°</button>

<input type="hidden" name="chat_log" id="chat_log">

<br><br>

<button class="otree-btn-next btn btn-success" id="nextBtn" style="display:none">ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™</button>

<script>
    let ai_turns = 0;
    const MAX_TURNS = 2; // ì‹¤í—˜ ì„¤ê³„ì— ë§ì¶° ì¡°ì ˆ

    const input = document.getElementById("user_input");
    const sendBtn = document.getElementById("sendBtn");
    const nextBtn = document.getElementById("nextBtn");
    const chatbox = document.getElementById("chatbox");

    // 1. ì„œë²„ë¡œë¶€í„° ì‘ë‹µì„ ë°›ì•˜ì„ ë•Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
    function liveRecv(data) {
        // ë¡œë”© ë©”ì‹œì§€ ì œê±°
        const loading = document.getElementById("loading-msg");
        if (loading) loading.remove();

        if (data.text) {
            ai_turns += 1;
            append("AI", data.text);
            
            if (ai_turns >= MAX_TURNS) {
                append("SYSTEM", "ëŒ€í™”ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. 'ë‹¤ìŒ' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
                nextBtn.style.display = "inline";
                input.disabled = true;
                sendBtn.disabled = true;
            } else {
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            }
        } else if (data.error) {
            append("SYSTEM", "ì˜¤ë¥˜: " + data.error);
            input.disabled = false;
            sendBtn.disabled = false;
        }
    }

    // 2. ì„œë²„ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” í•¨ìˆ˜
    function sendMessage() {
        let text = input.value.trim();
        if (text === "" || ai_turns >= MAX_TURNS) return;

        input.disabled = true;
        sendBtn.disabled = true;

        append("You", text);
        input.value = "";

        // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
        const loadingMsg = append("SYSTEM", "AIê°€ ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...");
        loadingMsg.id = "loading-msg";

        // ğŸ”¥ ì¤‘ìš”: oTree ì„œë²„ì˜ live_methodë¡œ ë°ì´í„° ì „ì†¡
        liveSend({'text': text});
    }

    function append(who, msg) {
        const line = document.createElement("div");
        line.innerHTML = "<b>" + who + ":</b> " + msg + "<br><br>";
        chatbox.appendChild(line);
        chatbox.scrollTop = chatbox.scrollHeight;
        return line;
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    sendBtn.onclick = sendMessage;
    input.onkeydown = function(e) {
        if (e.key === "Enter") {
            e.preventDefault();
            sendMessage();
        }
    };
</script>

{% endblock %}